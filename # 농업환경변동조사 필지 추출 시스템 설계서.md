# 농업환경변동조사 필지 추출 시스템 설계서

> Parcel Sampling Web System Design Document  
> Version 1.1 │ 2026년 1월 (지도 시각화 기능 추가)

---

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [시스템 아키텍처](#2-시스템-아키텍처)
3. [화면 설계](#3-화면-설계)
4. [핵심 알고리즘](#4-핵심-알고리즘)
5. [프로젝트 파일 구조](#5-프로젝트-파일-구조)
6. [엑셀 입출력 사양](#6-엑셀-입출력-사양)
7. [지도 시각화 기능](#7-지도-시각화-기능) ⭐ NEW
8. [개발 계획](#8-개발-계획)
9. [주요 고려사항 및 엣지 케이스](#9-주요-고려사항-및-엣지-케이스)

---

## 1. 프로젝트 개요

### 1.1 배경 및 목적

농업환경변동조사를 위해 매년 농가별 필지에서 토양 시료를 채취합니다. 2024년과 2025년에 이미 채취한 필지와 중복되지 않도록 2026년 시료 채취 대상 필지를 효율적으로 추출하는 웹 기반 시스템이 필요합니다.

**본 시스템은 다음 요구사항을 충족합니다:**

- 엑셀 파일(최대 4개) 업로드를 통해 기존 연도별 채취 필지와 전체 농가 필지 데이터를 등록
- 2024년 및 2025년 중복 필지를 자동 제외하고 2026년 추출 대상 필지 선별
- 총 700필지 추출 목표 (리(里)당 약 10필지, 농가당 1~2필지)
- 추출 결과 검토, 수동 조정 후 엑셀 다운로드
- **추출 필지를 카카오맵에 시각화** (주소 → 좌표 자동 변환, 리별 색상 구분, 경계선 표시)

### 1.2 핵심 제약 조건

| 항목 | 조건 | 비고 |
|------|------|------|
| 총 추출 필지 수 | 700필지 | 2026년 목표 |
| 리(里)당 추출 수 | 약 10필지 | 균등 분배 원칙 |
| 농가당 추출 수 | 최소 1필지, 최대 2필지 | 중복 방지 |
| 제외 조건 | 2024년 또는 2025년 채취 필지 | 자동 필터링 |
| 입력 파일 수 | 최대 4개 엑셀 파일 | xlsx, xls, csv 지원 |

### 1.3 기술 스택

| 구분 | 기술 | 사유 |
|------|------|------|
| Frontend | React 18 + TypeScript | 컴포넌트 기반 복잡한 UI 관리 |
| UI 라이브러리 | Tailwind CSS + shadcn/ui | 빠른 스타일링, 접근성 |
| 엑셀 처리 | SheetJS (xlsx) | 다양한 엑셀 포맷 지원 |
| 상태 관리 | Zustand | 경량, 직관적 전역 상태 |
| 테이블 UI | TanStack Table v8 | 가상화, 정렬/필터 지원 |
| 엑셀 내보내기 | xlsx + file-saver | 추출 결과 다운로드 |
| 빌드 도구 | Vite | 빠른 개발/빌드 |
| 백엔드 | 없음 (순수 클라이언트) | 서버 불필요, 보안성 우수 |
| **지도** | **카카오맵 SDK + Kakao Geocoding API** | **한국 주소 정확도 최고, 무료** |

---

## 2. 시스템 아키텍처

### 2.1 전체 흐름도

시스템의 데이터 흐름은 다음 4단계로 구성됩니다:

| 단계 | 명칭 | 주요 기능 |
|------|------|-----------|
| 1단계 | 파일 등록 | 엑셀 파일 업로드 및 컬럼 매핑 설정 |
| 2단계 | 데이터 분석 | 중복 필지 감지, 추출 가능 필지 분류 |
| 3단계 | 필지 추출 | 알고리즘 기반 자동 추출 + 수동 조정 |
| 4단계 | 결과 출력 | 미리보기, 검증, 엑셀 다운로드 |

### 2.2 데이터 모델

#### 2.2.1 핵심 데이터 구조

```typescript
interface Parcel {
  farmerId: string;         // 농가 고유 식별자
  farmerName: string;       // 농가명
  parcelId: string;         // 필지 고유번호
  address: string;          // 필지 주소 (법정동 포함)
  ri: string;               // 리(里) 명칭
  sigungu: string;          // 시군구
  eubmyeondong: string;     // 읍면동
  cropType?: string;        // 작물 유형 (선택)
  area?: number;            // 필지 면적 (m²)
  sampledYears: number[];   // 채취 연도 배열
  isEligible: boolean;      // 2026 추출 가능 여부
  isSelected: boolean;      // 최종 선택 여부
  fileSource: string;       // 원본 파일명
}
```

#### 2.2.2 파일 설정 구조

```typescript
interface FileConfig {
  id: string;               // 파일 고유 ID
  filename: string;         // 파일명
  year: 2024 | 2025 | 2026; // 해당 연도
  role: 'sampled' | 'master'; // sampled=기채취, master=전체필지
  columnMapping: {
    farmerId: string;       // 농가번호 컬럼명
    parcelId: string;       // 필지번호 컬럼명
    address: string;        // 주소 컬럼명
    ri?: string;            // 리 컬럼명 (없으면 주소에서 파싱)
  };
  rowCount: number;         // 총 행 수
  status: 'pending' | 'mapped' | 'loaded'; // 처리 상태
}
```

#### 2.2.3 추출 설정 구조

```typescript
interface ExtractionConfig {
  totalTarget: number;       // 총 추출 목표 (기본 700)
  perRiTarget: number;       // 리당 추출 수 (기본 10)
  minPerFarmer: number;      // 농가당 최소 (기본 1)
  maxPerFarmer: number;      // 농가당 최대 (기본 2)
  extractionMethod: 'random' | 'area' | 'farmerId'; // 추출 방식
  underfillPolicy: 'supplement' | 'skip';           // 미달 리 처리
  randomSeed?: number;       // 재현 가능 시드 (선택)
  excludedRis: string[];     // 제외 리 목록
  riTargetOverrides: Record<string, number>; // 리별 개별 목표 수
}
```

---

## 3. 화면 설계

### 3.1 화면 구성 개요

| 화면 ID | 화면명 | 경로 | 주요 기능 |
|---------|--------|------|-----------|
| SCR-001 | 파일 등록 | `/upload` | 엑셀 파일 업로드, 연도/역할 설정 |
| SCR-002 | 컬럼 매핑 | `/mapping` | 파일 컬럼 ↔ 시스템 필드 매핑 |
| SCR-003 | 데이터 분석 | `/analyze` | 중복 필지 현황, 추출 가능 통계 |
| SCR-004 | 추출 설정 | `/extract` | 추출 조건 설정 (리당 수, 농가당 수) |
| SCR-005 | 결과 검토 | `/review` | 추출 결과 테이블, 수동 조정 |
| SCR-005M | **지도 뷰** | `/review?tab=map` | **카카오맵 시각화, 리별 색상/경계** |
| SCR-006 | 다운로드 | `/export` | 엑셀 내보내기, 요약 보고서 |

### 3.2 SCR-001: 파일 등록 화면

#### 레이아웃

화면 상단에 진행 단계 표시바(Stepper)를 배치하고, 중앙에 파일 등록 영역 4개를 2×2 그리드로 배치합니다.

- 각 파일 슬롯에는 파일 드래그&드롭 영역, 연도 선택 (2024/2025/2026), 역할 선택 (기채취 파일 / 전체 필지 마스터) 포함
- 파일 업로드 시 시트 선택 드롭다운 표시 (다중 시트 엑셀 대응)
- 업로드된 파일의 상태를 카드 형태로 시각화: 파일명, 연도, 총 행 수, 매핑 상태 표시
- 하단에 '다음 단계: 컬럼 매핑' 버튼 (모든 파일 매핑 완료 시 활성화)

#### 필수 입력 항목

| 항목 | 필수 | 설명 |
|------|------|------|
| 전체 필지 마스터 파일 | 필수 | 농가별 모든 필지가 담긴 메인 파일 (2026 기준) |
| 2024년 채취 필지 파일 | 필수 | 2024년에 채취한 필지 목록 |
| 2025년 채취 필지 파일 | 필수 | 2025년에 채취한 필지 목록 |
| 추가 참고 파일 | 선택 | 비교 참고용 (이전 연도, 예비 목록 등) |

### 3.3 SCR-002: 컬럼 매핑 화면

- 업로드된 파일의 첫 5행 미리보기를 테이블로 표시
- 드롭다운으로 각 시스템 필드에 해당 파일의 컬럼을 매핑
- 주소 컬럼에서 리(里) 자동 파싱 기능 (파싱 규칙 선택 또는 직접 컬럼 지정)
- 매핑 완료 후 샘플 파싱 결과 즉시 미리보기
- '리 파싱 방식' 선택: 주소에서 자동 추출 / 별도 컬럼 지정 / 수동 입력

### 3.4 SCR-003: 데이터 분석 화면

파일 로드 후 자동으로 통계를 계산하여 카드 형태로 표시합니다:

| 통계 카드 | 내용 |
|-----------|------|
| 전체 필지 수 | 마스터 파일의 총 필지 수 |
| 2024 기채취 | 2024년 채취 필지 수 (중복 제외) |
| 2025 기채취 | 2025년 채취 필지 수 (중복 제외) |
| 추출 가능 필지 | 2024+2025 제외 후 남은 필지 수 |
| 리 수 | 주소에서 파싱된 고유 리(里) 수 |
| 목표 대비 | 700 목표 달성 가능 여부 표시 |

리(里)별 현황을 막대 차트 또는 테이블로 표시: 리명, 전체 필지 수, 추출 가능 수, 추출 목표 수

### 3.5 SCR-004: 추출 설정 화면

#### 추출 파라미터

| 파라미터 | 기본값 | 범위 | 설명 |
|----------|--------|------|------|
| 총 추출 목표 | 700 | 100~2000 | 전체 추출 목표 필지 수 |
| 리당 추출 수 | 10 | 1~50 | 각 리(里)에서 추출할 필지 수 |
| 농가당 최소 필지 | 1 | 1~5 | 농가당 최소 추출 필지 수 |
| 농가당 최대 필지 | 2 | 1~5 | 농가당 최대 추출 필지 수 |
| 추출 방식 | 랜덤 균등 | - | 랜덤 / 면적순 / 농가번호순 |
| 미달 리 처리 | 인접 리에서 보충 | - | 목표 미달 리 처리 방식 |

#### 고급 설정

- 특정 리(里) 제외 또는 우선순위 설정 기능
- 시드(Seed) 값 지정으로 재현 가능한 랜덤 추출
- 동일 농가의 필지 지리적 분산 여부 (주소 유사도 기반)

### 3.6 SCR-005: 결과 검토 화면

#### 메인 테이블

추출된 700필지를 인터랙티브 테이블로 표시합니다:

- 컬럼: 번호, 농가ID, 농가명, 필지번호, 주소, 리(里), 면적, 채취이력, 선택여부
- 행 클릭으로 선택/해제 토글
- 필지 추가 시 동일 리에서 대체 필지 자동 제안
- 리별 그룹핑 뷰 / 농가별 그룹핑 뷰 전환 기능
- 실시간 통계: 선택 수, 리별 분포, 농가당 평균
- 경고 표시: 리당 10개 미충족, 농가당 2개 초과 등

#### 필터 및 검색

- 시군구 / 읍면동 / 리(里) 계층형 필터
- 농가번호, 필지번호, 주소 텍스트 검색
- 채취이력 필터: 2024 채취 / 2025 채취 / 미채취 / 추출선택
- 이상 항목 표시 필터 (목표 미달 리, 초과 농가 등)

### 3.7 SCR-006: 결과 다운로드 화면

- 추출 결과 요약: 총 선택 수, 리별 분포 테이블, 검증 통과 여부
- 다중 시트 엑셀 파일 다운로드 버튼
- 처음부터 다시 시작 (초기화) 버튼

---

## 4. 핵심 알고리즘

### 4.1 중복 필지 감지 알고리즘

필지 고유 키를 조합하여 중복을 판별합니다. 단순 ID 매칭 외에 주소 기반 퍼지 매칭도 지원합니다:

```typescript
// 중복 키 생성 전략 (우선순위 순)
const getDuplicateKey = (parcel: Parcel): string => {
  // 1순위: farmerId + parcelId 조합
  if (parcel.farmerId && parcel.parcelId)
    return `${parcel.farmerId}_${parcel.parcelId}`;
  // 2순위: 정규화된 주소 문자열
  return normalizeAddress(parcel.address);
};

// 주소 정규화 (공백, 특수문자 제거)
const normalizeAddress = (address: string): string =>
  address.replace(/\s+/g, '').replace(/[^\w가-힣]/g, '');
```

### 4.2 필지 추출 알고리즘

리(里) 단위 계층적 추출 알고리즘을 사용합니다:

| 단계 | 처리 내용 |
|------|-----------|
| Step 1 | 전체 필지에서 2024, 2025 채취 필지를 제외하여 후보 풀 생성 |
| Step 2 | 후보 풀을 리(里) 기준으로 그룹핑 |
| Step 3 | 각 리의 목표 추출 수 계산: `min(리당 설정값, 리의 가용 필지 수)` |
| Step 4 | 각 리에서 농가 기반 랜덤 추출: 농가당 최대 2필지 제한 |
| Step 5 | 목표 700 미달 시: 가용 필지 많은 리에서 추가 추출 |
| Step 6 | 결과 검증: 리별 분포, 농가별 분포 조건 충족 확인 |

```typescript
function extractParcels(
  candidates: Parcel[],
  config: ExtractionConfig
): Parcel[] {
  // Step 1-2: 리별 그룹핑
  const riGroups = groupBy(candidates, (p) => p.ri);
  const selected: Parcel[] = [];

  // Step 3-4: 리별 추출
  for (const [ri, parcels] of Object.entries(riGroups)) {
    const target = config.riTargetOverrides[ri] ?? config.perRiTarget;
    const riSelected = extractFromRi(parcels, target, config);
    selected.push(...riSelected);
  }

  // Step 5: 미달 보충
  if (selected.length < config.totalTarget) {
    supplementFromLargeRi(selected, candidates, config);
  }

  return selected;
}

function extractFromRi(
  parcels: Parcel[],
  target: number,
  config: ExtractionConfig
): Parcel[] {
  // 농가별 그룹핑 후 농가당 최대 maxPerFarmer 제한
  const farmerGroups = groupBy(parcels, (p) => p.farmerId);
  const pool: Parcel[] = [];

  for (const farmerParcels of Object.values(farmerGroups)) {
    const shuffled = shuffle(farmerParcels, config.randomSeed);
    pool.push(...shuffled.slice(0, config.maxPerFarmer));
  }

  return shuffle(pool, config.randomSeed).slice(0, target);
}
```

### 4.3 주소에서 리(里) 파싱

한국 행정구역 주소에서 리(里)를 추출하는 파싱 규칙입니다:

```typescript
const parseRi = (address: string): string => {
  // 패턴: '~리' 매칭 (예: '충청남도 아산시 염치읍 강청리')
  const riMatch = address.match(/([가-힣]+리)(?:\s|$)/);
  if (riMatch) return riMatch[1];

  // 리가 없는 경우 읍면동 사용 (도시지역)
  const dongMatch = address.match(/([가-힣]+동|[가-힣]+읍|[가-힣]+면)/);
  return dongMatch ? dongMatch[1] : '미분류';
};
```

---

## 5. 프로젝트 파일 구조

```
parcel-sampling-system/
├── src/
│   ├── components/
│   │   ├── FileUploader/
│   │   │   ├── FileUploader.tsx        # 드래그&드롭 업로드 컴포넌트
│   │   │   ├── FileCard.tsx            # 업로드 파일 카드
│   │   │   └── SheetSelector.tsx       # 시트 선택 드롭다운
│   │   ├── ColumnMapper/
│   │   │   ├── ColumnMapper.tsx        # 컬럼 매핑 UI
│   │   │   └── PreviewTable.tsx        # 데이터 미리보기 테이블
│   │   ├── Analysis/
│   │   │   ├── StatsDashboard.tsx      # 통계 대시보드 카드
│   │   │   └── RiDistributionChart.tsx # 리별 분포 차트
│   │   ├── Extraction/
│   │   │   ├── ExtractionSettings.tsx  # 추출 파라미터 설정
│   │   │   └── RiTargetTable.tsx       # 리별 목표 설정 테이블
│   │   └── Review/
│   │       ├── ResultTable.tsx         # 추출 결과 테이블 (TanStack)
│   │       ├── ValidationPanel.tsx     # 검증 결과 패널
│   │       └── ExportButton.tsx        # 엑셀 내보내기 버튼
│   ├── lib/
│   │   ├── excelParser.ts              # SheetJS 파일 파싱
│   │   ├── addressParser.ts            # 리(里) 주소 파싱
│   │   ├── duplicateDetector.ts        # 중복 필지 감지
│   │   ├── extractionAlgorithm.ts      # 핵심 추출 알고리즘
│   │   └── excelExporter.ts            # 결과 엑셀 내보내기
│   ├── store/
│   │   ├── fileStore.ts                # 파일 상태 (Zustand)
│   │   ├── parcelStore.ts              # 필지 데이터 상태
│   │   └── extractionStore.ts          # 추출 설정/결과 상태
│   ├── pages/
│   │   ├── UploadPage.tsx              # SCR-001
│   │   ├── MappingPage.tsx             # SCR-002
│   │   ├── AnalyzePage.tsx             # SCR-003
│   │   ├── ExtractPage.tsx             # SCR-004
│   │   ├── ReviewPage.tsx              # SCR-005
│   │   └── ExportPage.tsx              # SCR-006
│   ├── types/
│   │   └── index.ts                    # 공통 타입 정의
│   ├── App.tsx
│   └── main.tsx
├── public/
├── package.json
├── tsconfig.json
└── vite.config.ts
```

---

## 6. 엑셀 입출력 사양

### 6.1 입력 파일 요구 사양

#### 마스터 파일 (전체 필지)

농가별 모든 접수 필지가 포함된 메인 파일입니다. 필수 컬럼은 다음과 같습니다:

| 컬럼명 (예시) | 필드 | 필수 | 설명 |
|---------------|------|------|------|
| 농가번호 | `farmerId` | 필수 | 농가 고유 식별자 |
| 농가명 | `farmerName` | 권장 | 농가 이름 |
| 필지번호 | `parcelId` | 필수 | 필지 고유 식별자 |
| 필지주소 | `address` | 필수 | 법정동 포함 전체 주소 |
| 리명 | `ri` | 권장 | 없으면 주소에서 자동 파싱 |
| 시군구 | `sigungu` | 권장 | 시/군/구 명칭 |
| 면적 | `area` | 선택 | 필지 면적 (m²) |
| 작물 | `cropType` | 선택 | 재배 작물명 |

#### 채취 이력 파일 (2024년, 2025년)

마스터 파일과 동일한 구조이거나, 최소 `farmerId` + `parcelId` 또는 `address` 컬럼만 있어도 됩니다.

### 6.2 출력 파일 사양

추출 결과는 다음 구조의 엑셀 파일로 내보냅니다:

| 시트명 | 내용 |
|--------|------|
| `2026_추출필지` | 최종 선택된 700필지 전체 목록 |
| `리별_통계` | 리(里)별 추출 수, 전체 수, 채취이력 요약 |
| `농가별_통계` | 농가별 선택 필지 수, 채취이력 요약 |
| `제외필지` | 2024/2025 중복으로 제외된 필지 목록 |
| `전체필지` | 마스터 파일 전체 (채취이력 컬럼 추가) |

### 6.3 엑셀 파일 비교 로직

4개 파일의 필지를 비교하는 매칭 우선순위:

| 우선순위 | 매칭 키 | 적용 조건 |
|----------|---------|-----------|
| 1순위 | 농가번호 + 필지번호 | 두 파일 모두 해당 컬럼 존재 시 |
| 2순위 | 정규화 주소 문자열 | ID 컬럼 없거나 매칭 실패 시 |
| 3순위 | 농가번호 + 정규화 주소 | 부분 매칭 (퍼지) |

---

## 7. 지도 시각화 기능

### 7.1 개요 및 핵심 과제

엑셀 데이터에 좌표 컬럼이 없으므로 **주소 → 위경도 변환(Geocoding)** 이 선행되어야 합니다. 이후 카카오맵 SDK로 마커·경계선을 렌더링합니다.

```
[주소 문자열]
    │
    ▼ Kakao Geocoding API (REST)
[위도 / 경도]
    │
    ▼ 브라우저 캐시 (localStorage)
[카카오맵 마커 / 오버레이]
```

### 7.2 카카오 API 설정

#### 필요한 API 키 2종

| 키 종류 | 용도 | 발급 위치 |
|---------|------|-----------|
| JavaScript 앱 키 | 지도 SDK 로드 | [kakao developers](https://developers.kakao.com) → 내 애플리케이션 |
| REST API 키 | 주소 → 좌표 변환 | 동일 애플리케이션 |

#### 무료 할당량

| API | 무료 한도 | 비고 |
|-----|-----------|------|
| 카카오맵 SDK | 무제한 | 지도 렌더링 |
| Geocoding (주소검색) | **300,000건/월** | 700필지 변환은 0.2% 사용 |

#### 환경 변수 설정 (`.env`)

```bash
VITE_KAKAO_JS_KEY=your_javascript_app_key
VITE_KAKAO_REST_KEY=your_rest_api_key
```

### 7.3 주소 → 좌표 변환 (Geocoding) 설계

#### 변환 흐름

```typescript
// 1. 캐시 확인 → 2. API 호출 → 3. 결과 저장
async function geocodeAddress(address: string): Promise<LatLng | null> {
  // Step 1: 로컬 캐시 확인 (이미 변환한 주소 재사용)
  const cached = geocodeCache.get(normalizeAddress(address));
  if (cached) return cached;

  // Step 2: Kakao Geocoding REST API 호출
  const res = await fetch(
    `https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(address)}`,
    { headers: { Authorization: `KakaoAK ${import.meta.env.VITE_KAKAO_REST_KEY}` } }
  );
  const data = await res.json();

  if (data.documents.length === 0) {
    // Step 2-1: 도로명 주소 실패 시 지번 주소로 재시도
    return geocodeByJibun(address);
  }

  const { x, y } = data.documents[0].address ?? data.documents[0].road_address;
  const result = { lat: parseFloat(y), lng: parseFloat(x) };

  // Step 3: 캐시 저장 (세션 동안 재사용)
  geocodeCache.set(normalizeAddress(address), result);
  return result;
}
```

#### 배치 변환 전략 (700건 처리)

```typescript
// API Rate Limit 초과 방지: 동시 요청 수 제한
async function batchGeocode(
  parcels: Parcel[],
  onProgress: (done: number, total: number) => void
): Promise<void> {
  const CONCURRENCY = 5;   // 동시 요청 5개
  const DELAY_MS   = 100;  // 요청 간 100ms 간격

  const chunks = chunkArray(parcels, CONCURRENCY);
  let done = 0;

  for (const chunk of chunks) {
    await Promise.all(
      chunk.map(async (parcel) => {
        parcel.coords = await geocodeAddress(parcel.address);
        done++;
        onProgress(done, parcels.length);
      })
    );
    await sleep(DELAY_MS);
  }
}
```

#### Geocoding 실패 처리

| 실패 원인 | 대응 방법 |
|-----------|-----------|
| 주소 불완전 (번지 없음) | 읍면동 수준까지만 변환 → 리 중심점에 마커 |
| API 할당량 초과 | 에러 토스트 표시, 변환된 건수만 지도에 표시 |
| 네트워크 오류 | 3회 재시도 후 건너뜀, 목록에 ⚠️ 표시 |
| 좌표 미변환 필지 | 지도에서 제외, 테이블에서 별도 색상 표시 |

### 7.4 SCR-005M: 지도 뷰 화면 설계

#### 화면 레이아웃

```
┌─────────────────────────────────────────────────────┐
│  [테이블 뷰]  [지도 뷰 ★]          Geocoding: 698/700 │  ← 탭 + 진행률
├────────────────────────┬────────────────────────────┤
│                        │  필터 패널                  │
│                        │  ┌──────────────────────┐  │
│     카카오맵            │  │ 리(里) 선택    [전체▼] │  │
│     (전체 화면)         │  │ 채취이력       [전체▼] │  │
│                        │  └──────────────────────┘  │
│  🔵🔴🟢 마커들          │                            │
│                        │  선택 필지 상세             │
│                        │  ┌──────────────────────┐  │
│                        │  │ 농가: 홍길동           │  │
│                        │  │ 필지: 1234-5          │  │
│                        │  │ 리: 강청리             │  │
│                        │  │ 면적: 1,200 m²        │  │
│                        │  └──────────────────────┘  │
└────────────────────────┴────────────────────────────┘
│  ● 추출선택(700)  ○ 추출제외  ▲ 좌표미변환(2)       │  ← 범례
└─────────────────────────────────────────────────────┘
```

#### 마커 색상 규칙

| 마커 색상 | 의미 |
|-----------|------|
| 🔵 파란색 | 2026 추출 선택 필지 |
| ⚫ 회색 | 추출 후보이나 미선택 |
| 🔴 빨간색 | 2024 채취 이력 (제외) |
| 🟠 주황색 | 2025 채취 이력 (제외) |
| ⚠️ 노란색 | 좌표 변환 실패 |

#### 리(里)별 색상 구분 구현

```typescript
// 리별 고유 색상 자동 생성 (HSL 색상환 균등 분배)
function generateRiColors(riList: string[]): Record<string, string> {
  return Object.fromEntries(
    riList.map((ri, i) => [
      ri,
      `hsl(${Math.round((i / riList.length) * 360)}, 65%, 55%)`
    ])
  );
}

// 마커 생성 시 리 색상 적용
function createMarker(parcel: Parcel, color: string): kakao.maps.Marker {
  const markerImage = new kakao.maps.MarkerImage(
    createColoredMarkerSVG(color),  // SVG로 색상 마커 생성
    new kakao.maps.Size(24, 35)
  );
  return new kakao.maps.Marker({
    position: new kakao.maps.LatLng(parcel.coords!.lat, parcel.coords!.lng),
    image: markerImage,
    title: `${parcel.farmerName} - ${parcel.parcelId}`
  });
}
```

### 7.5 리(里) / 행정구역 경계선 표시

#### 경계선 데이터 소스

국토정보플랫폼(Vworld) 또는 행정안전부 공공데이터에서 GeoJSON 형식으로 제공하는 법정경계 데이터를 활용합니다.

| 데이터 | 제공처 | 형식 | 비용 |
|--------|--------|------|------|
| 법정동 경계 (리 단위) | 행정안전부 공공데이터 | GeoJSON / SHP | 무료 |
| 필지 경계 (지적도) | 국토정보공사 Vworld | WMS/WFS | 무료 |

#### 경계선 렌더링 전략

```typescript
// GeoJSON 폴리곤을 카카오맵 Polygon으로 변환
function renderRiBoundaries(
  map: kakao.maps.Map,
  geoJson: GeoJSON.FeatureCollection,
  riColors: Record<string, string>,
  activeRis: string[]        // 현재 필지가 있는 리만 표시
): void {
  geoJson.features
    .filter(f => activeRis.includes(f.properties?.리명))
    .forEach(feature => {
      const riName = feature.properties?.리명;
      const coords = convertGeoJsonToKakao(feature.geometry);

      const polygon = new kakao.maps.Polygon({
        map,
        path: coords,
        strokeWeight: 2,
        strokeColor: riColors[riName] ?? '#666666',
        strokeOpacity: 0.8,
        fillColor: riColors[riName] ?? '#888888',
        fillOpacity: 0.1,   // 반투명 채우기
      });

      // 폴리곤 클릭 시 해당 리 필터 적용
      kakao.maps.event.addListener(polygon, 'click', () => {
        filterByRi(riName);
      });
    });
}
```

> **⚠️ 주의**: 법정경계 GeoJSON은 용량이 크므로(전국 기준 수십 MB) 해당 시군구 범위만 필터링해서 로드해야 합니다. 또는 Vworld WMS 타일 서비스를 레이어로 오버레이하는 방식이 더 가볍습니다.

### 7.6 마커 클릭 인포윈도우

```typescript
function createInfoWindow(parcel: Parcel): kakao.maps.InfoWindow {
  const content = `
    <div style="padding:12px; min-width:200px; font-family:'맑은 고딕',sans-serif;">
      <strong style="font-size:14px;">${parcel.farmerName}</strong>
      <hr style="margin:6px 0; border-color:#eee;">
      <table style="font-size:12px; border-collapse:collapse; width:100%;">
        <tr><td style="color:#888;padding:2px 8px 2px 0">필지번호</td>
            <td><b>${parcel.parcelId}</b></td></tr>
        <tr><td style="color:#888;padding:2px 8px 2px 0">주소</td>
            <td>${parcel.address}</td></tr>
        <tr><td style="color:#888;padding:2px 8px 2px 0">리(里)</td>
            <td>${parcel.ri}</td></tr>
        <tr><td style="color:#888;padding:2px 8px 2px 0">면적</td>
            <td>${parcel.area ? parcel.area.toLocaleString() + ' m²' : '-'}</td></tr>
        <tr><td style="color:#888;padding:2px 8px 2px 0">채취이력</td>
            <td>${parcel.sampledYears.length ? parcel.sampledYears.join(', ') + '년' : '없음'}</td></tr>
        <tr><td style="color:#888;padding:2px 8px 2px 0">2026 선택</td>
            <td><b style="color:${parcel.isSelected ? '#2563eb' : '#999'}">
              ${parcel.isSelected ? '✅ 추출 선택' : '미선택'}
            </b></td></tr>
      </table>
    </div>`;

  return new kakao.maps.InfoWindow({ content, removable: true });
}
```

### 7.7 Geocoding 진행률 UI

```tsx
// Geocoding 진행 중 표시 컴포넌트
function GeocodingProgressBar({ done, total }: { done: number; total: number }) {
  const pct = Math.round((done / total) * 100);
  return (
    <div className="flex items-center gap-3 px-4 py-2 bg-blue-50 rounded-lg">
      <div className="flex-1 bg-gray-200 rounded-full h-2">
        <div
          className="bg-blue-500 h-2 rounded-full transition-all"
          style={{ width: `${pct}%` }}
        />
      </div>
      <span className="text-sm text-gray-600 whitespace-nowrap">
        좌표 변환 중... {done}/{total} ({pct}%)
      </span>
    </div>
  );
}
```

### 7.8 추가 파일 구조 (지도 관련)

기존 파일 구조에 다음 파일들이 추가됩니다:

```
src/
├── components/
│   └── Map/
│       ├── KakaoMap.tsx            # 카카오맵 컨테이너 컴포넌트
│       ├── ParcelMarker.tsx        # 필지 마커 (색상/아이콘 처리)
│       ├── RiBoundary.tsx          # 리(里) 경계 폴리곤
│       ├── MarkerInfoWindow.tsx    # 마커 클릭 인포윈도우
│       ├── MapLegend.tsx           # 범례 패널
│       └── GeocodingProgress.tsx   # 변환 진행률 바
├── lib/
│   ├── kakaoGeocoder.ts            # 주소→좌표 변환 + 캐시
│   ├── batchGeocoder.ts            # 배치 변환 (concurrency 제어)
│   └── geoJsonConverter.ts         # GeoJSON → 카카오맵 좌표 변환
└── hooks/
    ├── useKakaoMap.ts              # 지도 초기화 훅
    └── useGeocoding.ts             # 배치 Geocoding 상태 관리 훅
```

---

## 8. 개발 계획

### 7.1 단계별 개발 순서 (Claude Code 기준)

| Phase | 작업 내용 | 예상 시간 |
|-------|-----------|-----------|
| Phase 1 | 프로젝트 초기화: Vite + React + TS, Tailwind, shadcn/ui, Zustand, SheetJS, TanStack Table 설치 및 라우터 구성 | 30분 |
| Phase 2 | 핵심 라이브러리 개발: `excelParser`, `addressParser`, `duplicateDetector`, `extractionAlgorithm` | 2~3시간 |
| Phase 3 | 파일 업로드 화면 (SCR-001): 드래그&드롭, 시트 선택, 파일 카드 컴포넌트 | 1~2시간 |
| Phase 4 | 컬럼 매핑 화면 (SCR-002): 미리보기 테이블, 매핑 드롭다운 | 1~2시간 |
| Phase 5 | 분석 대시보드 (SCR-003): 통계 카드, 리별 분포 시각화 | 1시간 |
| Phase 6 | 추출 설정 (SCR-004): 파라미터 폼, 리별 개별 설정 테이블 | 1시간 |
| Phase 7 | 결과 검토 (SCR-005): TanStack 테이블, 필터, 수동 조정, 검증 패널 | 2~3시간 |
| Phase 8 | **지도 시각화 (SCR-005M)**: 카카오맵 SDK 연동, Geocoding 배치 변환 구현 | **2~3시간** |
| Phase 9 | **지도 고도화**: 리 경계선(GeoJSON), 리별 색상 마커, 인포윈도우, 범례 | **1~2시간** |
| Phase 10 | 엑셀 내보내기 (SCR-006): 다중 시트 엑셀 생성 (좌표 컬럼 포함) | 1시간 |
| Phase 11 | 전체 통합 테스트 및 예외 처리 보강 | 1~2시간 |

**총 예상 개발 시간: 약 13~20시간**

### 7.2 패키지 설치 명령어

```bash
npm create vite@latest parcel-sampling-system -- --template react-ts
cd parcel-sampling-system

# 핵심 패키지
npm install zustand xlsx file-saver @tanstack/react-table
npm install -D tailwindcss postcss autoprefixer @types/file-saver

# 카카오맵 타입 정의
npm install -D @types/kakao.maps.d.ts

# shadcn/ui 초기화
npx shadcn-ui@latest init

# shadcn 컴포넌트 (필요한 것만)
npx shadcn-ui@latest add button card select table badge progress alert
```

#### `index.html`에 카카오맵 SDK 추가

```html
<!-- index.html <head> 에 추가 -->
<script
  type="text/javascript"
  src="//dapi.kakao.com/v2/maps/sdk.js?appkey=%VITE_KAKAO_JS_KEY%&libraries=services"
></script>
```

### 7.3 Claude Code 시작 프롬프트

Claude Code에서 다음 프롬프트로 개발을 시작할 수 있습니다:

```
농업환경변동조사 필지 추출 웹 시스템을 만들어줘.
Vite + React + TypeScript + Tailwind CSS + shadcn/ui 로 시작해.

핵심 기능:
1. 엑셀 파일 최대 4개 업로드 (SheetJS 사용)
2. 각 파일에 연도(2024/2025/마스터)와 컬럼 매핑 설정
3. 2024년과 2025년 채취 필지를 마스터에서 자동 제외
4. 리(里)당 10필지, 농가당 최대 2필지로 700필지 추출
5. TanStack Table로 결과 검토 및 수동 조정
6. 다중 시트 엑셀로 결과 내보내기

설계서 기반으로 단계별(Phase 1~9)로 개발해줘.
```

---

## 9. 주요 고려사항 및 엣지 케이스

### 8.1 데이터 품질 이슈

| 이슈 | 원인 | 처리 방법 |
|------|------|-----------|
| 주소 불일치 | 연도별 파일의 주소 표기 차이 | 정규화 함수로 공백/특수문자 제거 후 비교 |
| 리(里) 파싱 실패 | 도시 지역 또는 불완전한 주소 | '미분류' 그룹으로 별도 관리 |
| 농가번호 형식 차이 | 숫자/문자 혼용, 앞자리 0 처리 | `toString()` 정규화 후 비교 |
| 필지 수 부족 | 특정 리의 추출 가능 필지 < 10 | 실제 가용 수만큼 추출 + 경고 표시 |
| 빈 행/헤더 중복 | 엑셀 서식 문제 | 빈 행 자동 필터, 헤더 자동 감지 |
| 인코딩 문제 | 한글 깨짐 (EUC-KR) | SheetJS `codepage` 옵션으로 처리 |

### 8.2 성능 고려사항

- **대용량 엑셀 처리**: Web Worker 사용으로 UI 블로킹 방지 (10,000행 이상 시)
- **테이블 렌더링**: TanStack Table 가상화(virtualizer) 적용으로 대량 결과 최적화
- **상태 지속성**: Zustand persist 미사용 — 새로고침 시 데이터 초기화 (브라우저 메모리 내 처리)

### 8.3 UX 고려사항

- **단계 복귀**: 브라우저 세션 동안 이전 단계로 돌아갈 수 있도록 Zustand 상태 유지
- **미리보기 실행**: 추출 실행 전 결과 시뮬레이션 기능
- **운영 환경**: 모바일 반응형 불필요 (데스크탑 전용)
- **언어**: 한국어 UI 전용 (i18n 불필요)

### 8.4 검증 규칙

추출 완료 후 다음 항목을 자동 검증합니다:

```typescript
interface ValidationResult {
  isValid: boolean;
  warnings: ValidationWarning[];
  errors: ValidationError[];
}

// 검증 항목
const validationRules = [
  { check: (s) => s.total === 700,         level: 'error',   msg: '총 추출 수가 700이 아닙니다' },
  { check: (s) => s.minPerRi >= 8,         level: 'warning', msg: '10개 미만 리가 있습니다' },
  { check: (s) => s.maxPerFarmer <= 2,     level: 'error',   msg: '농가당 2개 초과 필지가 있습니다' },
  { check: (s) => s.duplicateCount === 0,  level: 'error',   msg: '2024/2025 중복 필지가 포함되었습니다' },
];
```

### 9.4 지도/Geocoding 관련 주의사항

| 항목 | 내용 |
|------|------|
| **API 키 보안** | `.env` 파일에 저장, `.gitignore` 필수. 카카오 JS키는 도메인 제한 설정 권장 |
| **Geocoding 캐시** | 동일 주소 중복 변환 방지 — `sessionStorage` 또는 Zustand store에 캐싱 |
| **농촌 주소 정확도** | 산, 임야, 비법정도로 주소는 변환 정확도 낮을 수 있음 → 읍면동 수준 폴백 |
| **좌표 내보내기** | Geocoding 완료 후 위도/경도를 엑셀 출력 시트에 자동 포함 (다음 연도 재사용 가능) |
| **GeoJSON 용량** | 전국 법정경계는 수십 MB — 해당 시군구 범위만 필터하거나 Vworld WMS 타일 방식 사용 |
| **오프라인 환경** | 인터넷 없는 환경에서는 Geocoding 불가 → 지도 탭 비활성화 및 안내 메시지 표시 |

---

*본 설계서는 Claude Code를 통한 개발을 위한 기술 명세서입니다. | Version 1.1 | 2026.01*
